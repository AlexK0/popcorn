
syntax = "proto3";

option go_package = "github.com/AlexK0/popcorn/internal/api/popcorn";

package popcorn;

service CompilationService {
    // Compilation api
    rpc StartCompilationSession(StartCompilationSessionRequest) returns (StartCompilationSessionReply) {}
    rpc SendHeaderSHA256(SendHeaderSHA256Request) returns (SendHeaderSHA256Reply) {}
    rpc SendHeader(SendHeaderRequest) returns (SendHeaderReply) {}
    rpc CompileSource (CompileSourceRequest) returns (CompileSourceReply) {}
    rpc CloseSession(CloseSessionRequest) returns (CloseSessionReply) {}

    // Service api
    rpc Status(StatusRequest) returns (StatusReply) {}
}

message SHA256Message {
    fixed64 B0_7 = 1;
    fixed64 B8_15 = 2;
    fixed64 B16_23 = 3;
    fixed64 B24_31 = 4;
}

message HeaderMetadata {
    string FilePath = 1;
    int64 MTime = 2;
}

message StartCompilationSessionRequest {
    SHA256Message UserID = 1;
    string SourceFilePath = 2;
    string Compiler = 3;
    repeated string CompilerArgs = 4;
    repeated HeaderMetadata RequiredHeaders = 5;
}

message StartCompilationSessionReply {
    uint64 SessionID = 1;
    repeated int32 MissedHeadersSHA256 = 2;
    repeated int32 MissedHeadersFullCopy = 3;
}

message SendHeaderSHA256Request {
    uint64 SessionID = 1;
    int32 HeaderIndex = 2;
    SHA256Message HeaderSHA256 = 3;
}

message SendHeaderSHA256Reply {
    bool FullCopyRequired = 1;
}

message SendHeaderRequest {
    uint64 SessionID = 1;
    int32 HeaderIndex = 2;
    bytes HeaderBody = 3;
}

message SendHeaderReply {
}

message CompileSourceRequest {
    uint64 SessionID = 1;
    bytes SourceBody = 2;
    bool CloseSessionAfterBuild = 3;
}

message CompileSourceReply {
    int32 CompilerRetCode = 1;
    bytes CompiledSource = 2;
    bytes CompilerStdout = 3;
    bytes CompilerStderr = 4;
}

message CloseSessionRequest {
    uint64 SessionID = 1;
}

message CloseSessionReply {
}

message StatusRequest {}

message StatusReply {
    string ServerVersion = 1;
    repeated string ServerArgs = 2;
    bytes ServerStats = 3;
}
